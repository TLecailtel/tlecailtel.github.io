<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Variation du nombre de voyageurs dans les gares SNCF</title>
  <script src="node_modules/d3/build/d3.min.js"></script>
  <script src="node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.min.js"></script>
  <style>
    body {margin: 0; position: fixed; top: 0; right: 0; bottom: 0; left: 0; font-family: Arial}
	p {margin: 0; padding: 0}
	.choiceZone {display: inline-block; margin-top: 2px; margin-bottom: 2px;}
	.hidden {display: none;}
	div.tooltip {color: #222; background-color: #fff; padding: .5em; text-shadow: #f5f5f5 0 1px 0; border-radius: 2px; opacity: 0.9; position: absolute;}
  </style>
</head>

<body>
	<div class="mapZone"></div>
  <script>
	
    var width = 700,
		height = 520;
		
	var svg = d3.select(".mapZone")
		.append("svg")
		.attr("width", width)
		.attr("height", height);
		
	var tooltip = d3.select('body').append('div')
        .attr('class', 'hidden tooltip');
    
    var projection = d3.geoConicConformal().center([2.454071, 46.279229]).scale(2800)
		.translate([width/2, height/2]);

    var path = d3.geoPath()
    	.projection(projection);

	var colorScale = d3.scaleLinear()
		.range([0,1]);
		
	var radiusScale = d3.scaleQuantile()
		.range([3,4,5,6,7,9]);
	
	function color(variation) {
		if(variation != 0) {
			return d3.interpolateRdYlGn(colorScale(variation));
		}
		else {
			return "grey";
		}
	}
	
	var firstStationSelected = null;
	var secondStationSelected = null;
	
	function colorInteraction() {
		if (firstStationSelected) {return "yellow"; }
		else {return "blue"; };
	}
	
	d3.json("cleaned_datasets/regions.geojson", function(json) {
		d3.csv("cleaned_datasets/all-joined-datasets.csv", function(data) {
			
			radiusScale.domain(data.map(function(d) {return +d.voyageurs_2016; }));
			
			var minVariation = d3.min(data, function(d) {return (+d.voyageurs_2016 - +d.voyageurs_2015)/+d.voyageurs_2015; });
			var maxVariation = d3.max(data, function(d) {return (+d.voyageurs_2016 - +d.voyageurs_2015)/+d.voyageurs_2015; });
			
			colorScale.domain([minVariation,maxVariation]);
		
			var regions = svg.append("g").attr("class","regions");
		
			var fond = regions.selectAll("g").data(json.features).enter().append("g").attr("class","region").attr("id",function(d) {return d.properties.nom; })
				.append("path")
				.attr("d", path)
				.attr("fill","#f5f5f5")
				.attr("stroke","black");
			
			var gares = svg.append("g").attr("class","gares");
			var nodes = [];
			
			data.forEach(function (d) {
				var proj = projection([d.Longitude_WGS84,d.Latitude_WGS84]);
				nodes.push({
					radius: radiusScale(+d.voyageurs_2016),
					color: color((+d.voyageurs_2016 - +d.voyageurs_2015)/+d.voyageurs_2015),
					cx: proj[0],
					cy: proj[1],
					name: d.Nom_de_la_gare,
					county: d.Departement,
					region: d.Region
				});
			});
			
			nodes.sort(function(a,b) {return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0); }); 
			
			var firstChoiceZone = d3.select("body").append("div").attr("class","choiceZone").attr("style","border: 2px solid blue;");
			
			firstChoiceZone.append("p").attr("class","choiceZone").text("Première gare sélectionnée : ");
			
			var firstDropdown = firstChoiceZone.append("select")
				.attr("class","choiceZone")
				.on("change",function() {
					firstStationSelected = d3.select(this).property("value");
				});

			var firstOptions = firstDropdown
				.selectAll("option")
				.data(nodes).enter()
				.append("option")
				.text(function(d) {return d.name; });
				
			var secondChoiceZone = d3.select("body").append("div").attr("class","choiceZone").attr("style","border: 2px solid yellow");
			
			secondChoiceZone.append("p").attr("class","choiceZone").text("Deuxième gare sélectionnée : ");
			
			var secondDropdown = secondChoiceZone.append("select")
				.attr("class","choiceZone")
				.on("change",function() {
					secondStationSelected = d3.select(this).property("value");
				});

			var secondOptions = secondDropdown
				.selectAll("option")
				.data(nodes).enter()
				.append("option")
				.text(function(d) {return d.name; });
			
			var simulation = d3.forceSimulation(nodes)
				.force("x", d3.forceX(function(d) {return d.cx; }).strength(0.55))
				.force("y", d3.forceY(function(d) {return d.cy; }).strength(0.55))
				.force("collide", d3.forceCollide().radius(function(d) { return d.radius + 0.3; }))
				.on("tick", ticked);

			function ticked() {
				var gare = gares.selectAll("circle").data(nodes);

				gare.enter()
					.append("circle")
					.attr("r", function(d) {return d.radius; })
					.style("stroke","grey")
					.style("fill", function(d) {return d.color; })
					.on("mousemove", function(d) {
						var mouse = d3.mouse(svg.node()).map(function(d) {return parseInt(d); });
						tooltip.classed("hidden", false)
							.attr("style", "left:" + (mouse[0] + 15) + "px; top:" + (mouse[1] - 35) + "px; border: 2px solid "+colorInteraction())
							.html("<p><strong>"+d.name+"</strong></p><p> Département : "+d.county+"</p><p> Région : "+d.region+"</p>");
					})
					.on("mouseenter", function(){
						d3.select(this).transition().style("fill", colorInteraction());
					})
					.on("mouseleave", function(){
						d3.select(this).transition().style("fill", function(d){return d.color; }).style("stroke-width", 1);
						tooltip.classed('hidden', true);
					})
					.on("click", function(d){
						d3.select(this)
							.transition().duration(100).style("stroke-width", 10)
							.transition().style("stroke-width", 1);
						if (firstStationSelected) {
							secondStationSelected = d.name;
							secondDropdown.property("value", secondStationSelected)
						}
						else {
							firstStationSelected = d.name;
							firstDropdown.property("value", firstStationSelected);
						}
					})
					.merge(gare)
					.attr("cx", function(d) {return d.x; })
					.attr("cy", function(d) {return d.y; });
			}
		});
	});
  </script>
</body>
